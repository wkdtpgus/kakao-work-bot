# ì£¼ê°„ìš”ì•½ ê²€ì¦ í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ê°œìš”

ì£¼ê°„ìš”ì•½ ê¸°ëŠ¥ì´ í‰ì¼ ì‘ì„± íšŸìˆ˜(weekday_record_count)ì™€ ì™„ë£Œ ì—¬ë¶€(weekly_completed_week)ì— ë”°ë¼ ì˜¬ë°”ë¥´ê²Œ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦í•˜ëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

## ì‚¬ì „ ì¤€ë¹„

1. **í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸**
   ```bash
   # .env íŒŒì¼ì— Supabase ì •ë³´ê°€ ìˆëŠ”ì§€ í™•ì¸
   cat .env | grep SUPABASE
   ```

2. **í…ŒìŠ¤íŠ¸í•  ì‚¬ìš©ì ID ì„¤ì •**
   - `test_simple.py` íŒŒì¼ì˜ `TEST_USER_ID` ë³€ìˆ˜ë¥¼ ì‹¤ì œ í…ŒìŠ¤íŠ¸í•  ì¹´ì¹´ì˜¤ ì‚¬ìš©ì IDë¡œ ë³€ê²½í•˜ì„¸ìš”
   - ê¸°ë³¸ê°’: `test_user_1762435436718`

## ì‚¬ìš© ë°©ë²•

### 1. í…ŒìŠ¤íŠ¸ ë°ì´í„° ì„¤ì • ë„êµ¬ ì‚¬ìš© (ì¶”ì²œ)

ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•ì…ë‹ˆë‹¤. ê°€ìƒ ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê³  ì¹´ì¹´ì˜¤í†¡ì—ì„œ ì§ì ‘ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
poetry run python test_simple.py
```

**ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ:**
- `1`: í‰ì¼ 2ì¼ ì‘ì„± (ìƒì„± ê°€ëŠ¥ âœ…)
- `2`: í‰ì¼ 1ì¼ ì‘ì„± (ë¶€ì¡± ì•ˆë‚´ âŒ)
- `3`: í‰ì¼ 2ì¼ + ì´ë¯¸ ì™„ë£Œ (ì¤‘ë³µ ë°©ì§€ âŒ)
- `4`: í‰ì¼ 0ì¼ (ì‹œì‘ ì „ ì•ˆë‚´ âŒ)
- `5`: ë°ì´í„° ì •ë¦¬ë§Œ

**í…ŒìŠ¤íŠ¸ ìˆœì„œ:**
1. ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ (ì˜ˆ: `1`)
2. ì„¤ì • ì™„ë£Œ ë©”ì‹œì§€ í™•ì¸
3. **ì¹´ì¹´ì˜¤í†¡**ì—ì„œ "ì£¼ê°„ìš”ì•½ ìƒì„±í•´ì¤˜" ì…ë ¥
4. ì‘ë‹µ í™•ì¸

**ì˜ˆìƒ ê²°ê³¼:**

| ì‹œë‚˜ë¦¬ì˜¤ | ì¡°ê±´ | ì˜ˆìƒ ì‘ë‹µ |
|---------|------|----------|
| 1 | í‰ì¼ 2ì¼ ì‘ì„± | ì£¼ê°„ìš”ì•½ v1.0 + ì—­ì§ˆë¬¸ 3ê°œ ì œê³µ |
| 2 | í‰ì¼ 1ì¼ ì‘ì„± | "ì´ë²ˆ ì£¼ í‰ì¼ ì‘ì„±ì´ 1ì¼ì´ì—ìš”. ì£¼ê°„ìš”ì•½ì€ í‰ì¼ 2ì¼ ì´ìƒ ì‘ì„± í›„..." |
| 3 | ì´ë¯¸ ì™„ë£Œ | "ì´ë²ˆ ì£¼ ì£¼ê°„ìš”ì•½ì€ ì´ë¯¸ ì™„ë£Œí•˜ì…¨ì–´ìš”! ë‹¤ìŒ ì£¼ì— ë‹¤ì‹œ ë§Œë‚˜ìš” ğŸ˜Š" |
| 4 | í‰ì¼ 0ì¼ | "ì•„ì§ ì¼ì¼ê¸°ë¡ì„ ì‹œì‘í•˜ì§€ ì•Šìœ¼ì…¨ì–´ìš”. í‰ì¼ì— ì¼ì¼ê¸°ë¡ì„..." |

### 2. ìë™í™”ëœ í†µí•© í…ŒìŠ¤íŠ¸ (ê°œë°œììš©)

ë‚´ë¶€ í•¨ìˆ˜ë¥¼ ì§ì ‘ í˜¸ì¶œí•˜ì—¬ ë¼ìš°íŒ…ê³¼ ì‘ë‹µì„ ìë™ìœ¼ë¡œ ê²€ì¦í•©ë‹ˆë‹¤.

```bash
poetry run python test_weekly_validation.py
```

ì´ í…ŒìŠ¤íŠ¸ëŠ”:
- LLMì„ í˜¸ì¶œí•˜ì—¬ ì˜ë„ë¥¼ ë¶„ë¥˜í•©ë‹ˆë‹¤
- ë¼ìš°íŒ… ë¡œì§ì„ ê²€ì¦í•©ë‹ˆë‹¤
- ì‹¤ì œ ì‘ë‹µ ë©”ì‹œì§€ë¥¼ ìƒì„±í•˜ê³  ê²€ì¦í•©ë‹ˆë‹¤

**ì£¼ì˜:** ì´ í…ŒìŠ¤íŠ¸ëŠ” LLM API í˜¸ì¶œì´ í•„ìš”í•˜ë¯€ë¡œ ë¹„ìš©ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ê²€ì¦ í¬ì¸íŠ¸

### 1. ë¼ìš°íŒ… ê²€ì¦

**ì‹œë‚˜ë¦¬ì˜¤ 1 (í‰ì¼ 2ì¼, ë¯¸ì™„ë£Œ):**
```
ğŸ“ ë¼ìš°íŒ… ê²°ê³¼: weekly_agent_node
âœ… ì˜¬ë°”ë¥¸ ë¼ìš°íŒ…: weekly_agent_node
âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ: ì£¼ê°„ìš”ì•½ v1.0 ìƒì„±ë¨
```

**ì‹œë‚˜ë¦¬ì˜¤ 2 (í‰ì¼ 1ì¼, ë¯¸ì™„ë£Œ):**
```
ğŸ“ ë¼ìš°íŒ… ê²°ê³¼: daily_agent_node, intent=daily_record, classified=weekly_insufficient
âœ… ì˜¬ë°”ë¥¸ ë¼ìš°íŒ…: daily_agent_node with weekly_insufficient
âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ: ë¶€ì¡± ì•ˆë‚´ ë©”ì‹œì§€ ë°˜í™˜
```

**ì‹œë‚˜ë¦¬ì˜¤ 3 (í‰ì¼ 2ì¼, ì™„ë£Œ):**
```
ğŸ“ ë¼ìš°íŒ… ê²°ê³¼: daily_agent_node, intent=daily_record, classified=weekly_already_completed
âœ… ì˜¬ë°”ë¥¸ ë¼ìš°íŒ…: daily_agent_node with weekly_already_completed
âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ: ì¤‘ë³µ ë°©ì§€ ë©”ì‹œì§€ ë°˜í™˜
```

**ì‹œë‚˜ë¦¬ì˜¤ 4 (í‰ì¼ 0ì¼, ë¯¸ì™„ë£Œ):**
```
ğŸ“ ë¼ìš°íŒ… ê²°ê³¼: daily_agent_node, intent=daily_record, classified=weekly_no_record
âœ… ì˜¬ë°”ë¥¸ ë¼ìš°íŒ…: daily_agent_node with weekly_no_record
âœ… í…ŒìŠ¤íŠ¸ ì„±ê³µ: ì‹œì‘ ì „ ì•ˆë‚´ ë©”ì‹œì§€ ë°˜í™˜
```

### 2. temp_data ê²€ì¦

ê° ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ í›„ temp_dataê°€ ì˜¬ë°”ë¥´ê²Œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤:

```python
temp_data = {
    "weekday_record_count": 2,           # í‰ì¼ ì‘ì„± íšŸìˆ˜
    "weekday_count_week": "2025-W45",    # í˜„ì¬ ì£¼
    "last_weekday_record_date": "2025-11-11",  # ë§ˆì§€ë§‰ ì‘ì„±ì¼
    "weekly_completed_week": None,       # ì™„ë£Œ ì£¼ì°¨ (None or "2025-W45")
    "weekly_qna_session": {}             # QnA ì„¸ì…˜ ìƒíƒœ
}
```

### 3. ì¼ì¼ ìš”ì•½ ë°ì´í„° ê²€ì¦

ê°€ìƒìœ¼ë¡œ ì‚½ì…ëœ ì¼ì¼ ìš”ì•½ ë°ì´í„°ë¥¼ Supabaseì—ì„œ í™•ì¸:

```sql
SELECT
    content,
    created_at,
    summary_type
FROM ai_answer_messages
WHERE kakao_user_id = 'test_user_1762435436718'
  AND is_summary = TRUE
  AND summary_type = 'daily'
ORDER BY created_at DESC;
```

ì›”ìš”ì¼, í™”ìš”ì¼ ë“± í‰ì¼ ë°ì´í„°ë§Œ ì‚½ì…ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

## ì£¼ê°„ìš”ì•½ ìƒì„± ì¡°ê±´ ìš”ì•½

ì£¼ê°„ìš”ì•½ì´ ìƒì„±ë˜ë ¤ë©´ ë‹¤ìŒ ì¡°ê±´ì„ **ëª¨ë‘** ë§Œì¡±í•´ì•¼ í•©ë‹ˆë‹¤:

1. âœ… **í‰ì¼ ì‘ì„± 2ì¼ ì´ìƒ**: `weekday_record_count >= 2`
2. âœ… **ì´ë²ˆ ì£¼ ë¯¸ì™„ë£Œ**: `weekly_completed_week != current_week`
3. âœ… **QnA ì„¸ì…˜ ë¹„í™œì„±**: `weekly_qna_session.active != true` (ì²« ìš”ì²­ ì‹œ)

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ: "Supabase ì—°ê²° ì‹¤íŒ¨" ì—ëŸ¬

**ì›ì¸:** í™˜ê²½ ë³€ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.

**í•´ê²°:**
```bash
# .env íŒŒì¼ í™•ì¸
cat .env | grep SUPABASE

# í•„ìš”í•œ ë³€ìˆ˜
SUPABASE_URL=https://...
SUPABASE_ANON_KEY=eyJ...
```

### ë¬¸ì œ: ë°ì´í„°ê°€ ì •ë¦¬ë˜ì§€ ì•ŠìŒ

**ì›ì¸:** ì´ë²ˆ ì£¼ ë‚ ì§œ ë²”ìœ„ ë°–ì˜ ë°ì´í„°ëŠ” ì •ë¦¬ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

**í•´ê²°:**
```bash
# ìˆ˜ë™ìœ¼ë¡œ ì •ë¦¬
poetry run python test_simple.py
# ì„ íƒ: 5 (ë°ì´í„° ì •ë¦¬ë§Œ)
```

### ë¬¸ì œ: ì¹´ì¹´ì˜¤í†¡ì—ì„œ ë‹¤ë¥¸ ì‘ë‹µì´ ë‚˜ì˜´

**ì›ì¸1:** QnA ì„¸ì…˜ì´ í™œì„±í™”ë˜ì–´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**í•´ê²°:**
```bash
# ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•˜ì—¬ temp_data ì´ˆê¸°í™”
poetry run python test_simple.py
# ê°™ì€ ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ
```

**ì›ì¸2:** weekday_record_countê°€ ì˜ˆìƒê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**í™•ì¸:**
```bash
poetry run python -c "
import asyncio
from src.database.database import Database

async def check():
    db = Database()
    conv_state = await db.get_conversation_state('test_user_1762435436718')
    print(conv_state.get('temp_data', {}))

asyncio.run(check())
"
```

## ì°¸ê³  ì‚¬í•­

- **í‰ì¼ ê¸°ì¤€**: ì›”ìš”ì¼(0) ~ ê¸ˆìš”ì¼(4)ë§Œ ì¹´ìš´íŠ¸ë©ë‹ˆë‹¤
- **ì£¼ì°¨ ê³„ì‚°**: `datetime.strftime('%Y-W%U')` í˜•ì‹ (ì˜ˆ: "2025-W45")
- **ë¦¬ì…‹ ì‹œì **: ë§¤ì£¼ ì›”ìš”ì¼ì— weekday_record_countê°€ 0ìœ¼ë¡œ ë¦¬ì…‹ë©ë‹ˆë‹¤
- **ì¤‘ë³µ ë°©ì§€**: weekly_completed_weekì™€ current_weekë¥¼ ë¹„êµí•˜ì—¬ ì¤‘ë³µ ìƒì„±ì„ ë°©ì§€í•©ë‹ˆë‹¤

## ë‹¤ìŒ ë‹¨ê³„

í…ŒìŠ¤íŠ¸ê°€ ì™„ë£Œë˜ë©´:

1. âœ… ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤ê°€ ì˜ˆìƒëŒ€ë¡œ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸
2. âœ… Supabaseì—ì„œ RPC í•¨ìˆ˜ ì‹¤í–‰ (ì•„ì§ ì•ˆ í–ˆë‹¤ë©´):
   ```sql
   -- supabase_migration.sqlì˜ RPC í•¨ìˆ˜ ì‹¤í–‰
   -- (Supabase SQL Editorì—ì„œ)
   ```
3. âœ… ì‹¤ì œ ì‚¬ìš©ìë¡œ í”„ë¡œë•ì…˜ í…ŒìŠ¤íŠ¸
4. ğŸš€ ë°°í¬!
